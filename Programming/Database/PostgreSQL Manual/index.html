<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>PostgreSQL Manual - Manuals</title>
        <link href="../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
        <link href="../../../extra.css" rel="stylesheet">

        <script src="../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../..">Manuals</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Programming <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">C++</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../C%2B%2B/C%20Manual/" class="dropdown-item">C Manual</a>
</li>
            
<li>
    <a href="../../C%2B%2B/C%2B%2B%20Debugging%20and%20Profiling/" class="dropdown-item">C++ Debugging and Profiling</a>
</li>
            
<li>
    <a href="../../C%2B%2B/C%2B%2B%20Manual/" class="dropdown-item">C++ Manual</a>
</li>
            
<li>
    <a href="../../C%2B%2B/C%2B%2B%20Workflow/" class="dropdown-item">C++ Workflow</a>
</li>
            
<li>
    <a href="../../C%2B%2B/CMake%20Manual/" class="dropdown-item">CMake Manual</a>
</li>
            
<li>
    <a href="../../C%2B%2B/Google%20Test/" class="dropdown-item">Google Test</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Cloud computing</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../Cloud%20computing/Lmod/" class="dropdown-item">Lmod</a>
</li>
            
<li>
    <a href="../../Cloud%20computing/RCI%20cluster/" class="dropdown-item">RCI cluster</a>
</li>
            
<li>
    <a href="../../Cloud%20computing/Slurm/" class="dropdown-item">Slurm</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Database</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../Database%20Workflow/" class="dropdown-item">Database Workflow</a>
</li>
            
<li>
    <a href="../PostgreSQL%20Debugging%20and%20Profiling/" class="dropdown-item">PostgreSQL Debugging and Profiling</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active">PostgreSQL Manual</a>
</li>
            
<li>
    <a href="../SQL%20Manual/" class="dropdown-item">SQL Manual</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Java</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../Java/Debugging%20Java/" class="dropdown-item">Debugging Java</a>
</li>
            
<li>
    <a href="../../Java/Jackson/" class="dropdown-item">Jackson</a>
</li>
            
<li>
    <a href="../../Java/Java%20Manual/" class="dropdown-item">Java Manual</a>
</li>
            
<li>
    <a href="../../Java/Java%20Workflow/" class="dropdown-item">Java Workflow</a>
</li>
            
<li>
    <a href="../../Java/Maven/" class="dropdown-item">Maven</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Python</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../Python/Matplotlib%20Manual/" class="dropdown-item">Matplotlib Manual</a>
</li>
            
<li>
    <a href="../../Python/Pandas%20Manual/" class="dropdown-item">Pandas Manual</a>
</li>
            
<li>
    <a href="../../Python/Plotly%20Manual/" class="dropdown-item">Plotly Manual</a>
</li>
            
<li>
    <a href="../../Python/Python%20Debugging/" class="dropdown-item">Python Debugging</a>
</li>
            
<li>
    <a href="../../Python/Python%20Manual/" class="dropdown-item">Python Manual</a>
</li>
            
<li>
    <a href="../../Python/Python%20Workflow/" class="dropdown-item">Python Workflow</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Web</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../Web/CSS%20Manual/" class="dropdown-item">CSS Manual</a>
</li>
            
<li>
    <a href="../../Web/css/" class="dropdown-item">css</a>
</li>
            
<li>
    <a href="../../Web/Google%20API%20and%20Apps%20Script/" class="dropdown-item">Google API and Apps Script</a>
</li>
            
<li>
    <a href="../../Web/htaccess/" class="dropdown-item">htaccess</a>
</li>
            
<li>
    <a href="../../Web/JavaScript/" class="dropdown-item">JavaScript</a>
</li>
            
<li>
    <a href="../../Web/Jekyll/" class="dropdown-item">Jekyll</a>
</li>
            
<li>
    <a href="../../Web/mkdocs/" class="dropdown-item">mkdocs</a>
</li>
            
<li>
    <a href="../../Web/Selenium/" class="dropdown-item">Selenium</a>
</li>
    </ul>
  </li>
                                    
<li>
    <a href="../../Common/" class="dropdown-item">Common</a>
</li>
                                    
<li>
    <a href="../../Git/" class="dropdown-item">Git</a>
</li>
                                    
<li>
    <a href="../../Gurobi/" class="dropdown-item">Gurobi</a>
</li>
                                    
<li>
    <a href="../../HDF/" class="dropdown-item">HDF</a>
</li>
                                    
<li>
    <a href="../../JSON/" class="dropdown-item">JSON</a>
</li>
                                    
<li>
    <a href="../../Native%20Libraries/" class="dropdown-item">Native Libraries</a>
</li>
                                    
<li>
    <a href="../../Neural%20Networks/" class="dropdown-item">Neural Networks</a>
</li>
                                    
<li>
    <a href="../../Perl/" class="dropdown-item">Perl</a>
</li>
                                    
<li>
    <a href="../../Regex/" class="dropdown-item">Regex</a>
</li>
                                    
<li>
    <a href="../../Ruby%20Workflow/" class="dropdown-item">Ruby Workflow</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">LaTeX <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../LaTeX/Latex%20manual/" class="dropdown-item">Latex manual</a>
</li>
                                    
<li>
    <a href="../../../LaTeX/LaTeX%20workflow/" class="dropdown-item">LaTeX workflow</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Linux <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../Linux/Linux%20Manual/" class="dropdown-item">Linux Manual</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Windows <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../Windows/Excel%20Manual/" class="dropdown-item">Excel Manual</a>
</li>
                                    
<li>
    <a href="../../../Windows/PowerPoint/" class="dropdown-item">PowerPoint</a>
</li>
                                    
<li>
    <a href="../../../Windows/Powershell%20Manual/" class="dropdown-item">Powershell Manual</a>
</li>
                                    
<li>
    <a href="../../../Windows/VSCode/" class="dropdown-item">VSCode</a>
</li>
                                    
<li>
    <a href="../../../Windows/Windows%20Manual/" class="dropdown-item">Windows Manual</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Audio & Video <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../Audio%20%26%20Video/FFMpeg/" class="dropdown-item">FFMpeg</a>
</li>
                                    
<li>
    <a href="../../../Audio%20%26%20Video/VLC/" class="dropdown-item">VLC</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">GIS <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../GIS/GIS%20formats/" class="dropdown-item">GIS formats</a>
</li>
                                    
<li>
    <a href="../../../GIS/Overpass%20Manual/" class="dropdown-item">Overpass Manual</a>
</li>
                                    
<li>
    <a href="../../../GIS/QGIS/" class="dropdown-item">QGIS</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Images <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../Images/Midjourney/" class="dropdown-item">Midjourney</a>
</li>
                                    
<li>
    <a href="../../../Images/Photopea/" class="dropdown-item">Photopea</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../../Arxiv/" class="nav-link">Arxiv</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../Google%20office%20apps/" class="nav-link">Google office apps</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../Hardware%20Manual/" class="nav-link">Hardware Manual</a>
                            </li>
                            <li class="navitem">
                                <a href="../../.." class="nav-link">index</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../Markdown/" class="nav-link">Markdown</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../Network/" class="nav-link">Network</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../Security/" class="nav-link">Security</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../vscode/" class="nav-link">vscode</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../Web%20Tricks/" class="nav-link">Web Tricks</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../XML/" class="nav-link">XML</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../YAML/" class="nav-link">YAML</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../Zotero/" class="nav-link">Zotero</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../PostgreSQL%20Debugging%20and%20Profiling/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../SQL%20Manual/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#data-types" class="nav-link">Data types</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#date" class="nav-link">Date</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="3"><a href="#select-a-part-of-datetimetimestamp" class="nav-link">Select a part of date/time/timestamp</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#auto-incrementing-columns" class="nav-link">Auto incrementing columns</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#strings" class="nav-link">Strings</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="3"><a href="#formatting-strings" class="nav-link">Formatting strings</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#arrays" class="nav-link">Arrays</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="3"><a href="#working-with-the-array-members-individualy" class="nav-link">Working with the array members individualy</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#converting-a-result-set-query-result-to-an-array" class="nav-link">Converting a result set (query result) to an array</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#creating-an-array-to-a-result-set" class="nav-link">Creating an array to a result set</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#hstore" class="nav-link">hstore</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#schemas" class="nav-link">Schemas</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#search-path" class="nav-link">Search path</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#creating-objects-tables-indexes-etc" class="nav-link">Creating objects (tables, indexes, etc.)</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#if-not-exists-modifier" class="nav-link">IF NOT EXISTS modifier</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#create-table-as" class="nav-link">CREATE TABLE AS</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#procedures-and-functions" class="nav-link">Procedures and functions</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#syntax" class="nav-link">Syntax</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#functions" class="nav-link">Functions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#procedures" class="nav-link">Procedures</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#function-and-procedure-parameters" class="nav-link">Function and procedure parameters</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#deciding-the-language" class="nav-link">Deciding the language</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#conditional-filters-based-on-the-value-of-a-variable-or-input-parameter" class="nav-link">Conditional filters based on the value of a variable or input parameter</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#organizing-functions-and-procedures" class="nav-link">Organizing functions and procedures</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#temporary-tables" class="nav-link">Temporary tables</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#do-command" class="nav-link">DO command</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#window-functions" class="nav-link">Window functions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#return-data-from-insert-update-and-delete-statements" class="nav-link">Return data from INSERT, UPDATE, and DELETE statements</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#various-specific-tasks" class="nav-link">Various specific tasks</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#selecting-rows-for-deletion-based-on-data-from-another-table" class="nav-link">Selecting rows for deletion based on data from another table</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#handeling-duplicates-in-the-insert-statement" class="nav-link">Handeling duplicates in the INSERT statement</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#random-oredering" class="nav-link">Random oredering</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="3"><a href="#random-ordering-with-a-seed-pseudo-random-ordering" class="nav-link">Random ordering with a seed (Pseudo-random ordering)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#postgis" class="nav-link">PostGis</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#geometry-columns" class="nav-link">Geometry columns</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#spatial-indexing" class="nav-link">Spatial Indexing</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#converting-between-geometry-types" class="nav-link">Converting between geometry types</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#compute-area-surrounding-geometries" class="nav-link">Compute area surrounding geometries</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#split-area-to-polygons-based-on-points" class="nav-link">Split area to polygons based on points</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#other-useful-functions" class="nav-link">Other Useful Functions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#plpgsql" class="nav-link">PL/pgSQL</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#blocks" class="nav-link">Blocks</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#variables" class="nav-link">Variables</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="3"><a href="#assigning-a-value-to-a-variable-using-sql" class="nav-link">Assigning a value to a variable using SQL</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#functions-and-procedures" class="nav-link">Functions and procedures</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="3"><a href="#returning-data" class="nav-link">Returning data</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="4"><a href="#return-next-and-return-query" class="nav-link">RETURN NEXT and RETURN QUERY</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#branching" class="nav-link">Branching</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#logging" class="nav-link">Logging</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#executing-functions" class="nav-link">Executing functions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#exceptions" class="nav-link">Exceptions</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="3"><a href="#handling-exceptions" class="nav-link">Handling exceptions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#raising-exceptions" class="nav-link">Raising exceptions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#query-diagnostics" class="nav-link">Query diagnostics</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#transaction-management" class="nav-link">Transaction management</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="3"><a href="#subtransactions" class="nav-link">Subtransactions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#psql" class="nav-link">psql</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#meta-commands" class="nav-link">meta-commands</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#importing-data" class="nav-link">Importing data</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#importing-compressed-sql-dump" class="nav-link">Importing compressed SQL dump</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#importing-data-from-csv" class="nav-link">Importing data from csv</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="3"><a href="#importing-data-from-csv-with-columns-than-are-not-in-the-db-table" class="nav-link">Importing data from csv with columns than are not in the db table</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#importing-data-from-a-shapefile" class="nav-link">Importing data from a shapefile</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#importing-data-from-geojson" class="nav-link">Importing data from GeoJSON</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#exporting-data" class="nav-link">Exporting data</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#exporting-the-database-server-configuration" class="nav-link">Exporting the database server configuration</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#compressing-the-sql-dump" class="nav-link">Compressing the SQL dump</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#exporting-data-to-csv" class="nav-link">Exporting data to csv</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#information-and-statistics" class="nav-link">Information and statistics</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#databases" class="nav-link">Databases</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#pgrouting" class="nav-link">PgRouting</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#finding-strongly-connected-components" class="nav-link">Finding strongly connected components</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#creating-vertices-from-edges" class="nav-link">Creating vertices from edges</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#testing-with-pgtap" class="nav-link">Testing with PgTAP</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#installation" class="nav-link">Installation</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="3"><a href="#linux" class="nav-link">Linux</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#windows" class="nav-link">Windows</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#basic-usage-test-scripts" class="nav-link">Basic Usage - Test scripts</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#pg_prove" class="nav-link">pg_prove</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#test-as-functions" class="nav-link">Test as functions</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="3"><a href="#test-runner" class="nav-link">Test runner</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#fixtures" class="nav-link">Fixtures</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#rolling-back" class="nav-link">Rolling back</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#test-assertions" class="nav-link">Test assertions</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="3"><a href="#result-set-assertions" class="nav-link">Result set assertions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#additional-functions-diagnostics" class="nav-link">Additional functions( Diagnostics )</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#xml" class="nav-link">XML</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#handling-xml-namespaces" class="nav-link">Handling XML namespaces</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#xmltable" class="nav-link">XMLTABLE</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#troubleshooting" class="nav-link">Troubleshooting</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#select-postgresql-version" class="nav-link">Select PostgreSQL version</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#select-postgis-version" class="nav-link">Select PostGIS version</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#tried-to-send-an-out-of-range-integer-as-a-2-byte-value" class="nav-link">Tried to send an out-of-range integer as a 2-byte value</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<p>fido7382</p>
<h1 id="data-types">Data types<a class="headerlink" href="#data-types" title="Permanent link">&para;</a></h1>
<p><a href="https://www.postgresql.org/docs/current/datatype.html">official documentation</a></p>
<h2 id="date">Date<a class="headerlink" href="#date" title="Permanent link">&para;</a></h2>
<p><a href="https://www.postgresql.org/docs/current/datatype-datetime.html">official documentation</a></p>
<ul>
<li><code>date</code>: for dates</li>
<li><code>time</code> for time</li>
<li><code>timestmp</code> for both date and time</li>
<li><code>interval</code></li>
</ul>
<h3 id="select-a-part-of-datetimetimestamp">Select a part of date/time/timestamp<a class="headerlink" href="#select-a-part-of-datetimetimestamp" title="Permanent link">&para;</a></h3>
<p>If we want just a part of a date, time, or timestamp, we can use the <code>extract</code> function. Example:</p>
<pre><code class="language-sql">SELECT extract(hour FROM &lt;date column name&gt;) FROM...
</code></pre>
<p>Other parts can be extracted too. To extract <strong>day of week</strong>, we can use <code>isodow</code> (assigns 1 to Monday and 7 to Sunday).</p>
<h2 id="auto-incrementing-columns">Auto incrementing columns<a class="headerlink" href="#auto-incrementing-columns" title="Permanent link">&para;</a></h2>
<p>In PostgreSQL, sequences are used for auto-incrementing columns. When you are creating a new db table or adding a new column, the process of creating a new sequence can be automated by choosing an <code>identity</code> or a <code>serial</code> column type.</p>
<p>When updating an aexisting column, a manual intervention is required:</p>
<ol>
<li>change the column to some numerical datatype</li>
<li>create the sequence:
    <code>SQL
    CREATE SEQUENCE &lt;SEQUENCE NAME&gt; OWNED BY &lt;TABLE NAME&gt;.&lt;COLUMN NAME&gt;;</code></li>
<li>adjust the value of the sequence:
    <code>SQL
    SELECT setval(pg_get_serial_sequence('&lt;TABLE NAME&gt;', '&lt;COLUMN NAME&gt;'), max(&lt;COLUMN NAME&gt;)) FROM &lt;TABLE NAME&gt;;</code></li>
<li>set the column to be incremented by the sequence:
    <code>SQL
    ALTER TABLE &lt;TABLE NAME&gt;
    ALTER COLUMN &lt;COLUMN NAME&gt; SET DEFAULT nextval('&lt;SEQUENCE NAME&gt;');</code></li>
</ol>
<h2 id="strings">Strings<a class="headerlink" href="#strings" title="Permanent link">&para;</a></h2>
<p><a href="https://www.postgresql.org/docs/current/datatype-character.html">official documentation</a></p>
<p>The most important string type is <code>text</code>, it is a variable unlimited length string, like we know it from programming languages.</p>
<p>Other types are:</p>
<ul>
<li><code>name</code>: An internal type for database object names. It is limited to 63 characters.</li>
</ul>
<p>There are many string function available, For all functions, check the <a href="https://www.postgresql.org/docs/9.1/functions-string.html">documentation</a>.</p>
<h3 id="formatting-strings">Formatting strings<a class="headerlink" href="#formatting-strings" title="Permanent link">&para;</a></h3>
<p>For formatting strings, we can use the <a href="https://www.postgresql.org/docs/current/functions-string.html#FUNCTIONS-STRING-FORMAT"><code>format</code></a>. Unlike in other languages, there are different types:</p>
<ul>
<li><code>%I</code>: SQL identifier. This one is used for, e.g., table names. The string is quoted if necessary.</li>
<li><code>%L</code>: SQL Literal. Automatically quotes the string if it is not <code>NULL</code>.</li>
<li><code>%s</code>: String. For everything else.</li>
</ul>
<h2 id="arrays">Arrays<a class="headerlink" href="#arrays" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://www.postgresql.org/docs/current/arrays.html">arrays</a></li>
<li><a href="https://www.postgresql.org/docs/8.4/functions-array.html">array functions and operators</a></li>
</ul>
<p>Arrays are <strong>declared</strong> as <code>&lt;type&gt;[]</code>, e.g., <code>integer[]</code>. The type can be any type, including composite types.</p>
<p>Array <strong>literals</strong> are declared using we use single quatation and curly brackets, e.g., <code>'{1, 2, 3}'</code>. For the same purpose, we can use the <code>ARRAY</code> constructtor sytax: <code>ARRAY[1, 2, 3]</code>. If we use the <code>ARRAY</code> constructor with an empty array, we have to specify the type of the array, e.g., <code>ARRAY[]::integer[]</code>. </p>
<p>To compute array <strong>length</strong>, use <code>array_length(&lt;array&gt;, 1)</code> where <code>1</code> stands for the first dimension. Note that <strong>most of the array functions return <code>NULL</code> if the array is empty.</strong></p>
<p>To check that some value match at least some member of the array, we use <code>ANY</code>:</p>
<pre><code class="language-SQL">SELECT ...
FROM tab
WHERE tab.a = ANY(&lt;array&gt;)
</code></pre>
<h3 id="working-with-the-array-members-individualy">Working with the array members individualy<a class="headerlink" href="#working-with-the-array-members-individualy" title="Permanent link">&para;</a></h3>
<p>For using the members of an array in the <code>SELECT</code> or <code>JOIN</code>, we have to first split the array using the <code>unnest</code> function. This function transforms the result set to a form where there is a separate row for each member of the array (a kind of inverse operation to group by).</p>
<p>If we want to also keep the array index, we can use the <code>WITH ORDINALITY</code> expression, as shown in the <a href="https://www.postgresql.org/docs/current/functions-srf.html">manual</a> or on <a href="https://stackoverflow.com/questions/8760419/postgresql-unnest-with-element-number">SO</a>.</p>
<h3 id="converting-a-result-set-query-result-to-an-array">Converting a result set (query result) to an array<a class="headerlink" href="#converting-a-result-set-query-result-to-an-array" title="Permanent link">&para;</a></h3>
<p>There are two ways to convert a result set to array in PostgreSQL:</p>
<ul>
<li>If we want to convert the whole result set to a single array, we use the <a href="https://www.postgresql.org/docs/current/sql-expressions.html#SQL-SYNTAX-ARRAY-CONSTRUCTORS">array constructor</a>:
    <code>SQL
    SELECT array(&lt;query&gt;);</code></li>
<li>If the query aggregates the rows and we want to create an array for each group, we use the <code>array_agg</code> function (see <a href="https://www.postgresql.org/docs/current/functions-aggregate.html#FUNCTIONS-AGGREGATES">aggregate functions</a>):
    <code>SQL
    SELECT array_agg(&lt;column name&gt;) FROM &lt;table name&gt;;</code><ul>
<li>note that counterintuitively, <strong>the <code>array_agg</code> function returns <code>NULL</code> if the result set is empty, not an empty array.</strong></li>
</ul>
</li>
</ul>
<h3 id="creating-an-array-to-a-result-set">Creating an array to a result set<a class="headerlink" href="#creating-an-array-to-a-result-set" title="Permanent link">&para;</a></h3>
<p>The opposite operation to the section above is to convert an array to a result set. This can be done using the <code>unnest</code> function:</p>
<pre><code class="language-SQL">SELECT unnest(&lt;array&gt;) AS &lt;column name&gt;;
</code></pre>
<h2 id="hstore">hstore<a class="headerlink" href="#hstore" title="Permanent link">&para;</a></h2>
<p>A specific feature of PostgreSQL is the <a href="https://www.postgresql.org/docs/current/hstore.html"><code>hstore</code></a> column type. It enables to store structured data in a single column. It can be used to dump variables that we do not plan to utilize in the database (i.e., in the SELECT, JOIN statements) frequently. </p>
<p>This data type requires the <code>hstore</code> extension to be enabled in the database. To enable it, use the following command:</p>
<pre><code class="language-SQL">CREATE EXTENSION hstore;
</code></pre>
<p>When we, exceptionally, want to access a variable from a hstore column, we can use the following syntax:</p>
<pre><code class="language-SQL">SELECT &lt;COLUMN NAME&gt;-&gt;&lt;VARIABLE NAME&gt; AS ...
</code></pre>
<h1 id="schemas">Schemas<a class="headerlink" href="#schemas" title="Permanent link">&para;</a></h1>
<p><a href="https://www.postgresql.org/docs/current/ddl-schemas.html">official documentation</a></p>
<p>Schemas in PostgreSQL are implemented as namespaces according to the SQL standard. They are intended to organize the database objects into logical groups. Unfortunately, they cannot be nested, so they can hardly be used as a replacement for namespaces/packages/modules in programming languages.</p>
<h2 id="search-path">Search path<a class="headerlink" href="#search-path" title="Permanent link">&para;</a></h2>
<p><a href="https://www.postgresql.org/docs/current/ddl-schemas.html#DDL-SCHEMAS-PATH">official documentation</a></p>
<p>Usually, we does not have to qualify the table name with the schema name, as the schema name is in the <em>search path</em>.</p>
<p>By default the search path is set to <code>"$user", public</code>, which means that the tables are first searched in the schema with the same name as the user, and then in the <code>public</code> schema.</p>
<p>To show the current search path, run:</p>
<pre><code class="language-SQL">SHOW search_path;
</code></pre>
<p>To change the search path, run:</p>
<pre><code class="language-SQL">SET search_path TO &lt;schema name list&gt;;
</code></pre>
<h1 id="creating-objects-tables-indexes-etc">Creating objects (tables, indexes, etc.)<a class="headerlink" href="#creating-objects-tables-indexes-etc" title="Permanent link">&para;</a></h1>
<p>The syntax for creating objects is mostly the same as in the SQL standard: </p>
<pre><code class="language-SQL">CREATE &lt;object type&gt; &lt;object name&gt; &lt;object parameters&gt;
</code></pre>
<h2 id="if-not-exists-modifier"><code>IF NOT EXISTS</code> modifier<a class="headerlink" href="#if-not-exists-modifier" title="Permanent link">&para;</a></h2>
<p>An important modifier is the <code>IF NOT EXISTS</code> clause that prevents errors when the object already exists. This is very useful if we want to update the database schema that is in the development phase with some automated script without the need to drop the database every time. However, this modifier is not available for all objects. It is available for:</p>
<ul>
<li><code>TABLE</code></li>
<li><code>INDEX</code></li>
<li><code>SEQUENCE</code></li>
<li><code>VIEW</code></li>
<li><code>MATERIALIZED VIEW</code></li>
<li><code>PROCEDURE</code></li>
<li><code>FUNCTION</code></li>
<li><code>TRIGGER</code></li>
<li><code>SCHEMA</code></li>
</ul>
<p>However, it is not available for:</p>
<ul>
<li><code>DATABASE</code></li>
<li><code>USER</code></li>
<li><code>CONSTRAINT</code></li>
</ul>
<p>For these objects, we have to use some workaround. There are three options in general:</p>
<ol>
<li>check if the object exists before creating it (<a href="https://stackoverflow.com/a/6804058/1827955">SO example with Constraint</a>)</li>
<li>delete the object before creating it</li>
<li>catch the error and ignore it (<a href="https://stackoverflow.com/a/32526723/1827955">SO example with Constraint</a>)</li>
</ol>
<h2 id="create-table-as"><code>CREATE TABLE AS</code><a class="headerlink" href="#create-table-as" title="Permanent link">&para;</a></h2>
<p><a href="https://www.postgresql.org/docs/current/sql-createtableas.html">documentation</a></p>
<p>The <code>CREATE TABLE AS</code> syntax is mostly equivalent to the SQL standard. An addition is the <code>WITH NO DATA</code> which we can put after the <code>SELECT</code> statement:</p>
<pre><code class="language-PostgreSQL">CREATE TABLE &lt;table name&gt; AS
SELECT &lt;select statement&gt;
WITH NO DATA
</code></pre>
<p>This way, we use the result of the <code>SELECT</code> statement to create the table structure, but the table is empty.</p>
<h1 id="procedures-and-functions">Procedures and functions<a class="headerlink" href="#procedures-and-functions" title="Permanent link">&para;</a></h1>
<p>To store a set of SQL commands for later use, PostgreSQL provides two options: procedures and functions. Both are similar and can use SQL, PL/pgSQL, or other languages supported by PostgreSQL. The key differences are:</p>
<ul>
<li>functions return a value, while procedures do not. However, procedures can return a value using an <code>OUT</code> parameter.</li>
<li>functions can be called in SQL queries, while procedures require a separate <code>CALL</code> statement.<ul>
<li>functions: <code>... SELECT &lt;function name&gt;(&lt;function arguments&gt;) ...</code></li>
<li>procedures: <code>CALL &lt;procedure name&gt;(&lt;procedure arguments&gt;);</code></li>
</ul>
</li>
<li>procedures can manage transactions, while functions cannot.</li>
</ul>
<h2 id="syntax">Syntax<a class="headerlink" href="#syntax" title="Permanent link">&para;</a></h2>
<p>Both functions and procedures have the following syntax:</p>
<pre><code class="language-SQL">CREATE OR REPLACE &lt;FUNCTION/PROCEDURE&gt; &lt;name&gt; (&lt;parameters&gt;)
&lt;return definition - only for functions&gt;
LANGUAGE &lt;language name&gt;
AS
&lt;body&gt;
</code></pre>
<p>where <code>&lt;body&gt;</code> can be both a delimited string:</p>
<pre><code class="language-SQL">AS $$
&lt;function content&gt;
$$
</code></pre>
<p>OR an active SQL body, if we use SQL language (since PostgreSQL 14):</p>
<pre><code class="language-SQL">BEGIN ATOMIC
    &lt;sql statements&gt;
END
</code></pre>
<p>There are some differences between those syntaxes (e.g., the second one works only for SQL and is evaluated/checked for validity at the time of creation), but in most cases, they are interchangable.</p>
<p>The <code>&lt;function content&gt;</code> depends on the language used:</p>
<ul>
<li>for SQL, it is a set of SQL statements</li>
<li>for PL/pgSQL, it is a <em>block</em>. See the <a href="#functions-and-procedures">functions and procedures</a> section of the PL/pgSQL chapter.</li>
</ul>
<h2 id="functions">Functions<a class="headerlink" href="#functions" title="Permanent link">&para;</a></h2>
<p>To call a function, we use the <code>SELECT</code> statement:</p>
<pre><code class="language-SQL">SELECT * FROM &lt;function signature&gt;
</code></pre>
<p>To create a function, we use the <a href="https://www.postgresql.org/docs/12/sql-createfunction.html">CREATE FUNCTION statement</a>.</p>
<p>Unlike for procedures, we need to specify a return type for function, either as an <code>OUT</code>/<code>INOUT</code> parameter, or using the <code>RETURNS</code> clause. To return tabular data, we use <a href="https://www.postgresql.org/docs/current/xfunc-sql.html#XFUNC-SQL-FUNCTIONS-RETURNING-TABLE"><code>TABLE</code></a> or <code>SETOF &lt;row type&gt;</code> return type:</p>
<pre><code class="language-SQL">RETURNS TABLE(&lt;param 1 name&gt; &lt;param 1 type&gt;, ..., &lt;param n name&gt; &lt;param n type&gt;)
RETURNS SETOF &lt;row type&gt;
</code></pre>
<p><strong>Note that <code>TABLE</code> and <code>SETOF</code> types can only be used as a return type of a function.</strong></p>
<h2 id="procedures">Procedures<a class="headerlink" href="#procedures" title="Permanent link">&para;</a></h2>
<p>To exectue a stored procedure, use:</p>
<pre><code class="language-SQL">CALL &lt;procedure name&gt;(&lt;procedure arguments&gt;);
</code></pre>
<p>To create a procedure, use the <a href="https://www.postgresql.org/docs/current/sql-createprocedure.html"><code>CREATE PROCEDURE</code> command</a>. The syntax is as follows:</p>
<pre><code class="language-SQL">CREATE PROCEDURE &lt;name&gt; (&lt;params&gt;)
LANGUAGE &lt;language name&gt;
&lt;procedure body&gt;
</code></pre>
<h2 id="function-and-procedure-parameters">Function and procedure parameters<a class="headerlink" href="#function-and-procedure-parameters" title="Permanent link">&para;</a></h2>
<p>The definition of parameters of functions and procedures are composed of three parts:</p>
<ol>
<li>mode: <code>IN</code>, <code>OUT</code>, or <code>INOUT</code> (optional, default is <code>IN</code>)</li>
<li>name: the name of the parameter (optional, default for <code>OUT</code> parameters generated)</li>
<li>type: the type of the parameter</li>
</ol>
<p>Unlike in programing languages, there is no implicit type cast of the program arguments, including literals. Therefore, we need to cast all parameters explicitely, as in the following example:</p>
<pre><code class="language-SQL">CREATE OR REPLACE PROCEDURE compute_speeds_for_segments(target_area_id smallint)
...

CALL compute_speeds_for_segments(1::smallint);
</code></pre>
<h2 id="deciding-the-language">Deciding the language<a class="headerlink" href="#deciding-the-language" title="Permanent link">&para;</a></h2>
<p>For simple statements, we can use the SQL language. We need the PL/pgSQL if:</p>
<ul>
<li>we need to use variables or control statements specific to PL/pgSQL</li>
<li>we need to use temporary tables, as the SQL language fails to recognize them if they are created inside the function/procedure</li>
</ul>
<h2 id="conditional-filters-based-on-the-value-of-a-variable-or-input-parameter">Conditional filters based on the value of a variable or input parameter<a class="headerlink" href="#conditional-filters-based-on-the-value-of-a-variable-or-input-parameter" title="Permanent link">&para;</a></h2>
<p>To add some filter to the <code>WHERE</code> or <code>ON</code> clause of a query based on the value of a variable or input parameter, we can use the following technique:</p>
<ol>
<li>set the variable or input parameter to <code>NULL</code> if we do not want to apply the filter</li>
<li>in the filter test for disjunction of NULL or the filter condition</li>
</ol>
<p>Example:</p>
<pre><code class="language-SQL">SELECT ... FROM ... 
WHERE param IS NULL OR some_column = param
</code></pre>
<h2 id="organizing-functions-and-procedures">Organizing functions and procedures<a class="headerlink" href="#organizing-functions-and-procedures" title="Permanent link">&para;</a></h2>
<p>A natural task that emerge if there is a lot of functions and procedures is to organize them into packages. Unfortunately, PostgreSQL does not support any such feature. The closest thing is a schema, however, schemas are not suitable for this purpose, as they cannot be nested.</p>
<h1 id="temporary-tables">Temporary tables<a class="headerlink" href="#temporary-tables" title="Permanent link">&para;</a></h1>
<p>To use a result set efficiently in a function or procedure, we often use temporary tables. Unlike in other relational database systems, in PostgreSQl, the lifetime of a temporary table is bound to a session. Therefoe, if we call a function that creates a tempoary table multiple times in a single session, we encounter an error, because the table already exists.</p>
<p>To tackle this problem, we need to delete all temporary tables manually. Luckily, there is a special <a href="https://www.postgresql.org/docs/current/sql-discard.html"><code>DISCARD</code></a> command that can be used to dtop all temporary tables at once:</p>
<pre><code class="language-SQL">DISCARD TEMPORARY;
</code></pre>
<h1 id="do-command"><code>DO</code> command<a class="headerlink" href="#do-command" title="Permanent link">&para;</a></h1>
<p>The <a href="https://www.postgresql.org/docs/12/sql-do.html"><code>DO</code> command</a> can be used to execude an anonymus code block in any of the languages suported by PostgreSQL.
It behaves like a function with no parameters and no return value. Syntax:</p>
<pre><code class="language-SQL">DO [LANGUAGE &lt;lang name&gt;] &lt;code&gt;
</code></pre>
<p>The default language is <code>plpgsql</code>.</p>
<p>Example:</p>
<pre><code class="language-SQL">DO $$
BEGIN
    RAISE NOTICE 'Hello world';
END
$$
</code></pre>
<h1 id="window-functions">Window functions<a class="headerlink" href="#window-functions" title="Permanent link">&para;</a></h1>
<p>PostgreSQL supports an extended syntax for <a href="https://www.postgresql.org/docs/current/tutorial-window.html">window functions</a>.</p>
<p>We can use it for example to retrieve the value of a column that has maximum value in another column, as demonstrated in an <a href="https://stackoverflow.com/questions/73773017/sql-group-by-get-value-on-one-column-based-on-order-of-another-column">SO answer</a>.</p>
<h1 id="return-data-from-insert-update-and-delete-statements">Return data from <code>INSERT</code>, <code>UPDATE</code>, and <code>DELETE</code> statements<a class="headerlink" href="#return-data-from-insert-update-and-delete-statements" title="Permanent link">&para;</a></h1>
<p>In PostgreSQL, the <code>INSERT</code>, <code>UPDATE</code>, and <code>DELETE</code> statements can return data with the <code>RETURNING</code> clause. The syntax is as follows:</p>
<pre><code class="language-SQL">INSERT INTO &lt;table name&gt; ... RETURNING &lt;column name&gt;
</code></pre>
<p>This is especially useful when inserting data into a table with an auto-incrementing column, as we can retrieve the value of the column after the insert.</p>
<h1 id="various-specific-tasks">Various specific tasks<a class="headerlink" href="#various-specific-tasks" title="Permanent link">&para;</a></h1>
<h2 id="selecting-rows-for-deletion-based-on-data-from-another-table">Selecting rows for deletion based on data from another table<a class="headerlink" href="#selecting-rows-for-deletion-based-on-data-from-another-table" title="Permanent link">&para;</a></h2>
<p>If we want to delete rows from a table based on some condition on data from another table, we can use the <code>DELETE</code> statement with a <code>USING</code> clause. Example:</p>
<pre><code class="language-SQL">DELETE FROM nodes_ways_speeds
USING nodes_ways
WHERE
    nodes_ways_speeds.to_node_ways_id = nodes_ways.id
    AND nodes_ways.area IN (5,6)
</code></pre>
<h2 id="handeling-duplicates-in-the-insert-statement">Handeling duplicates in the <code>INSERT</code> statement<a class="headerlink" href="#handeling-duplicates-in-the-insert-statement" title="Permanent link">&para;</a></h2>
<p>To handle duplicates on <code>INSERT</code>, PostgreSQL provides the <code>ON CONFLICT</code> clause (see the <a href="https://www.postgresql.org/docs/current/sql-insert.html"><code>INSERT</code></a> documentation).</p>
<p>The options are:</p>
<ul>
<li><code>DO NOTHING</code>: do nothing</li>
<li><code>DO UPDATE SET &lt;column name&gt; = &lt;value&gt;</code>: update the column to the given value</li>
</ul>
<h2 id="random-oredering">Random oredering<a class="headerlink" href="#random-oredering" title="Permanent link">&para;</a></h2>
<p>To order the result set randomly, we can use the <code>RANDOM()</code> function in the <code>ORDER BY</code> clause:</p>
<pre><code class="language-SQL">SELECT ...
FROM ...
ORDER BY RANDOM()
</code></pre>
<h3 id="random-ordering-with-a-seed-pseudo-random-ordering">Random ordering with a seed (Pseudo-random ordering)<a class="headerlink" href="#random-ordering-with-a-seed-pseudo-random-ordering" title="Permanent link">&para;</a></h3>
<p>To receive a determinisic (repeatable) random ordering, we can use the <code>setseed</code> function:</p>
<pre><code class="language-SQL">SELECT setseed(0.5);
SELECT ...
FROM ...
ORDER BY RANDOM();
</code></pre>
<p>Note that we need two queries, one for setting the seed and one for the actual query. If we does not have an option to call arbitrary queries, we have to use <code>UNION</code>:</p>
<pre><code class="language-SQL">SELECT col_1, ..., col_n FROM (
    SELECT _, null AS col_1, ..., null AS col_n FROM setseed(0.5)
    UNION ALL
    SELECT null AS _, col_1, ..., col_n
    FROM ...
    OFFSET 1
)
ORDER BY RANDOM()
</code></pre>
<p>The <code>OFFSET 1</code> is used to skip the first row, which is the result of the <code>setseed</code> function.</p>
<p>The union is the only way to guarantee that the seed will be set before the actual query. Other options, such as <code>WITH</code> or <code>SELECT ... FROM (SELECT setseed(0.5))</code> do not guarantee the order of execution, and produce a different result for each call.</p>
<h1 id="postgis">PostGis<a class="headerlink" href="#postgis" title="Permanent link">&para;</a></h1>
<p>PolsGIS is an extension for PostgreSQL that adds support for spatial data. </p>
<p>To enable the extension, we need to:</p>
<ol>
<li>install the extension<ul>
<li>e.g., using the bundeled stack builder application</li>
</ul>
</li>
<li>enable the extension in the database
    <code>SQL
    CREATE EXTENSION postgis;</code></li>
</ol>
<h2 id="geometry-columns">Geometry columns<a class="headerlink" href="#geometry-columns" title="Permanent link">&para;</a></h2>
<p>Postgis features can be utilized with geometry and geography column types. To add a new geometry column:</p>
<pre><code class="language-SQL">ADD COLUMN &lt;COLUUMN NAME&gt; geometry(&lt;GEOMETRY TYPE&gt;, &lt;SRID&gt;)
</code></pre>
<h2 id="spatial-indexing">Spatial Indexing<a class="headerlink" href="#spatial-indexing" title="Permanent link">&para;</a></h2>
<p><a href="http://postgis.net/workshops/postgis-intro/indexing.html">Documentation</a></p>
<p>Analogously to standard SQL column indicis, there are spatial indices in PostGIS. The only difference is that we need to add the <code>USING GIST</code> at the end of the <code>CREATE INDEX</code> statement:</p>
<pre><code class="language-SQL">CREATE INDEX nodes_geom_idx
  ON nodes
  USING GIST (geom);
</code></pre>
<h2 id="converting-between-geometry-types">Converting between geometry types<a class="headerlink" href="#converting-between-geometry-types" title="Permanent link">&para;</a></h2>
<p>There are dedicated functions whcich we can use to convert between geometry types:</p>
<ul>
<li><code>ST_Multi</code>: converts geometries to their multi-variant, e.g., <code>LineString</code> to <code>MultiLineString</code>.</li>
</ul>
<h2 id="compute-area-surrounding-geometries">Compute area surrounding geometries<a class="headerlink" href="#compute-area-surrounding-geometries" title="Permanent link">&para;</a></h2>
<p>If we are ok with a convex envelope of the geometries, we can simply use the <a href="https://postgis.net/docs/ST_ConvexHull.html"><code>St_ConvexHull</code></a> functon. Howeever, if we need the exact shape, We have to use the <a href="https://postgis.net/docs/ST_ConcaveHull.html"><code>St_ConcaveHull</code></a> function which computes the concave hull of a geometry.</p>
<p>The <code>St_ConcaveHull</code> function takes an additional parameter <code>param_pctconvex</code> which determines how <em>concave</em> is the result: 0 means strictly concave, while 1 means convex hull. Note that while lowere values leads to more acurate results, the computation is much slower. There is also another parameter <code>param_allow_holes</code> which determines whether holes in the object are permited (default false).</p>
<h2 id="split-area-to-polygons-based-on-points">Split area to polygons based on points<a class="headerlink" href="#split-area-to-polygons-based-on-points" title="Permanent link">&para;</a></h2>
<p>The split of spece into polygons based on a set of points is called <em>Voronoi diagram</em>. In PostGIS, we have a <a href="https://postgis.net/docs/ST_VoronoiPolygons.html">`ST_Voronoi_Polygons</a> for that. To obtain a set of polygons from a set of points, it is necessary to</p>
<ol>
<li>Aggregate the rows (<code>ST_Collect</code>)</li>
<li>Compute the polygon geometry (<code>ST_Voronoi_Polygons</code>)</li>
<li>Disaggregate the geometry into individual polygons (<code>ST_Dump</code>)</li>
</ol>
<p>Also, there is an important aspect of how far the polygons will reach outside of the points. By default, it enlarge the area determined by the points by about 50%. If we need a larger area, we can use the <code>extend_to</code> parameter. If we need a smaller area, however, we need to compute the intersection with this smaller area afterwards manually.</p>
<p>Full example:</p>
<pre><code class="language-SQL">SELECT st_intersection(
    (st_dump(
        st_voronoipolygons(st_collect(&lt;GEOMETRY COLUMN&gt;))
    )).geom, 
    (&lt;select clause for area of desired voronoi polygons&gt;)
) AS geom FROM ...
</code></pre>
<p><strong>If we need to join the polygons to the original points, we need to do it manually</strong> (e.g. by <code>JOIN ... ON ST_Within(&lt;POINT COLUMN&gt;, &lt;VORONOI POLYGONS GEO DUMP&gt;)</code> ).</p>
<h2 id="other-useful-functions">Other Useful Functions<a class="headerlink" href="#other-useful-functions" title="Permanent link">&para;</a></h2>
<ul>
<li>[<code>ST_Within</code>] <code>ST_Within</code>(A, B) if A is completly inside B</li>
<li><a href="https://postgis.net/docs/ST_Intersects.html"><code>ST_Intersects</code></a> <code>ST_Intersects(g1, g2)</code> if <code>g1</code> and <code>g2</code> have at least one point in common.</li>
<li><a href="https://postgis.net/docs/ST_Transform.html"><code>ST_Transform</code></a>: <code>ST_Transform(g, srid)</code> transforms geometry <code>g</code> to a projection defined by the <code>srid</code> and returns the result as a geometry.</li>
<li><a href="https://postgis.net/docs/ST_Buffer.html"><code>ST_Buffer</code></a>: <code>ST_Buffer(g, radius)</code> computes a geometry that is an extension of <code>g</code> by <code>radius</code> to all directions</li>
<li><a href="https://postgis.net/docs/ST_Collect.html"><code>St_Collect</code></a> aggregates data into single geometry. It is usually apllied to a geometry column in an SQL selection.</li>
<li><a href="https://postgis.net/docs/ST_Union.html"><code>ST_Union</code></a></li>
<li><a href="https://postgis.net/docs/ST_Equals.html"><code>ST_Equals</code></a></li>
<li><a href="https://postgis.net/docs/ST_MakeLine.html"><code>ST_MakeLine</code></a>: make line between two points</li>
<li><a href="https://postgis.net/docs/ST_SetSRID.html"><code>ST_SetSRID</code></a>: sets the <code>SRID</code> of the geometry and returns the result as a new geometry.</li>
<li><a href="https://postgis.net/docs/ST_MakePoint.html"><code>ST_MakePoint</code></a>: creates a point geometry from the given coordinates.</li>
<li><a href="https://postgis.net/docs/ST_Area.html"><code>ST_Area</code></a>: computes the area of a geometry. The units of the result are the same as the units of the <code>SRID</code> of the geometry (use UTM coordinate system for getting the area in square meters).</li>
</ul>
<h1 id="plpgsql">PL/pgSQL<a class="headerlink" href="#plpgsql" title="Permanent link">&para;</a></h1>
<p><a href="https://www.postgresql.org/docs/current/plpgsql.html">PL/pgSQL</a> is a procedural language available in PostgreSQL databases. It can be used inside:</p>
<ul>
<li>functions</li>
<li>procedures</li>
<li><code>DO</code> command</li>
</ul>
<h2 id="blocks">Blocks<a class="headerlink" href="#blocks" title="Permanent link">&para;</a></h2>
<p><a href="https://www.postgresql.org/docs/8.1/plpgsql-structure.html">Documentation</a></p>
<p>The base components of PL/pgSQL is a <em>block</em>. It's syntax is as follows:</p>
<pre><code class="language-SQL">DECLARE
    &lt;variable declarations&gt;
BEGIN
    &lt;statements&gt;
END
</code></pre>
<p>Here, the <code>DECLARE</code> part is optional.</p>
<p>In a block, each statement or declaration ends with a semicolon.</p>
<p>We can nest the blocks, i.e., we can put a block inside another block, between the <code>BEGIN</code> and <code>END</code> keywords. In this case, we put a semicolon after the inner block. Only the outer block that contains the whole content of the function/procedure/<code>DO</code> command does not require a semicolon.</p>
<h2 id="variables">Variables<a class="headerlink" href="#variables" title="Permanent link">&para;</a></h2>
<p>In PL/PgSQL, all variables must be <a href="https://www.postgresql.org/docs/current/plpgsql-declarations.html"><em>declared</em></a> before assignmant in the <code>DECLARE</code> block which is before the sql body of the function/procedure/<code>DO</code>. The syntax is:</p>
<pre><code class="language-SQL">&lt;variable name&gt; &lt;variable type&gt;[ = &lt;varianle value&gt;];
</code></pre>
<p>Example:</p>
<pre><code class="language-PostgreSQL">CREATE OR REPLACE PROCEDURE compute_speeds_for_segments()
    LANGUAGE plpgsql
AS
$$
DECLARE
    dataset_quality smallint = 1;
BEGIN
    ...
</code></pre>
<p>The, the value of a variable can be change using the classical assignment syntax:</p>
<pre><code class="language-SQL">&lt;variable name&gt; = &lt;varianle value&gt;;
</code></pre>
<p>Be carful to <strong>not use a variable name equal to the name of some of the columns</strong> used in the same context, which results in a name clash.</p>
<p>Nothe that <strong><code>:=</code> is also a valid assignment operator</strong>. There is no difference between <code>=</code> and <code>:=</code> in plpgsql. The <code>:=</code> operator is sometimes preferred to avoid confusion with the <code>=</code> operator used for comparison. </p>
<h3 id="assigning-a-value-to-a-variable-using-sql">Assigning a value to a variable using SQL<a class="headerlink" href="#assigning-a-value-to-a-variable-using-sql" title="Permanent link">&para;</a></h3>
<p>There are two options how to assign a value to a variable using SQL:</p>
<ul>
<li>using the <code>INTO</code> clause in the <code>SELECT</code> statement</li>
<li>using a <code>SELECT</code> statement as rvlaue of the assignment</li>
</ul>
<p>Example with <code>INTO</code>:</p>
<pre><code class="language-PostgreSQL">SELECT name INTO customer_name FROM customers WHERE id = 1
</code></pre>
<p>EXAMPLE with <code>SELECT</code> as rvalue:</p>
<pre><code class="language-PostgreSQL">customer_name = (SELECT name FROM customers WHERE id = 1)
</code></pre>
<p>Note that the behavior of the assignment may not be intuitive:</p>
<ul>
<li><strong>if the <code>SELECT</code> statement returns no rows, the variable is set to <code>NULL</code></strong></li>
<li>if the <code>SELECT</code> statement returns more than one row, an error is raised</li>
</ul>
<h2 id="functions-and-procedures">Functions and procedures<a class="headerlink" href="#functions-and-procedures" title="Permanent link">&para;</a></h2>
<p>The root of a PL/pgSQL function content is a <a href="#blocks"><em>block</em></a>.</p>
<h3 id="returning-data">Returning data<a class="headerlink" href="#returning-data" title="Permanent link">&para;</a></h3>
<p><a href="https://www.postgresql.org/docs/current/plpgsql-control-structures.html#PLPGSQL-STATEMENTS-RETURNING">Documentation</a></p>
<p>When using SQL language, we can return the data just by executing a <code>SELECT</code> statement:</p>
<pre><code class="language-SQL">CREATE OR REPLACE FUNCTION &lt;function name&gt; (&lt;parameters&gt;)
LANGUAGE SQL
AS
$$
SELECT ...
$$
</code></pre>
<p>When using PL/pgSQL, we have to use the <code>RETURN</code> statement. To make it even more complicated, there are three versions of the <code>RETURN</code> statement:</p>
<ul>
<li><code>RETURN &lt;expression&gt;</code>: This one is for:<ul>
<li>returning a single scalar value</li>
<li>return from function with return type <code>void</code>. In this case, the <code>&lt;expression&gt;</code> is empty.</li>
</ul>
</li>
<li><code>RETURN NEXT &lt;expression&gt;</code> and <code>RETURN QUERY &lt;query&gt;</code>: These are for returning a set of rows.</li>
</ul>
<p>As the <code>RETURN NEXT</code> and <code>RETURN QUERY</code> do not terminate the function, we can mix them with the <code>RETURN</code> statement. Additionally, the <code>RETURN QUERY</code> can be used multiple times in a single function and therefore, it is valid to use all three versions in a single function.</p>
<h4 id="return-next-and-return-query"><code>RETURN NEXT</code> and <code>RETURN QUERY</code><a class="headerlink" href="#return-next-and-return-query" title="Permanent link">&para;</a></h4>
<p><a href="https://www.postgresql.org/docs/current/plpgsql-control-structures.html#PLPGSQL-STATEMENTS-RETURNING-RETURN-NEXT">Documentation</a></p>
<p>For returning a set of rows (<code>table</code> or <code>setof</code> type) in <code>PL/PgSQL</code> , we have to use the <code>RETURN NEXT</code> or <code>RETURN QUERY</code> statement. Besides the fact that these statements are used for returning a set of rows, there is another important difference between them and the <code>RETURN</code> statement: <strong>they do not terminate the execution of the function</strong>. This is useful as sometimes, we need to do some cleanup after selecting the rows to be returned from function, or we need to build the result in a loop. In classical programming languages, we use variables for this purpose. In <code>PG/plSQL</code>, we can also use the <a href="https://www.postgresql.org/docs/current/plpgsql-control-structures.html#PLPGSQL-STATEMENTS-RETURNING"><code>RETURN NEXT</code> and <code>RETURN QUERY</code></a> constructs. Example:</p>
<pre><code class="language-PostgreSQL">RETURN QUERY SELECT ...;
DROP TABLE target_ways;
RETURN;
</code></pre>
<p>The <code>RETURN QUERY</code> differs from <code>RETURN NEXT</code> in following ways:</p>
<ul>
<li>its argument is a query, not an expression. Therefore we can use it directly with the <code>SELECT</code> statement, instead of using a variable.</li>
<li>it appends the result of the query to the result set. Therefore, it can be used multiple times in a single function.</li>
<li>it cannot be used for returning a single value even if the query returns a single value. If we have a single value return type and need to do some postprocessing between selecting the value and returning from the function, we have to use a variable instead.</li>
</ul>
<h2 id="branching">Branching<a class="headerlink" href="#branching" title="Permanent link">&para;</a></h2>
<p>PL/pgSQL has the following branching:</p>
<pre><code class="language-SQL">IF &lt;condition&gt; THEN
    ...
[ELSEIF
    ...
]
[ELSE
    ...
]
END IF
</code></pre>
<p>Note that <code>NULL</code> values are treated the same as in SQL: <strong>if the condition evaluates to <code>NULL</code>, the branch is not executed</strong>. This is different from other programming languages, where <code>NULL</code> is treated as <code>false</code>.</p>
<h2 id="logging">Logging<a class="headerlink" href="#logging" title="Permanent link">&para;</a></h2>
<p><a href="https://www.postgresql.org/docs/current/plpgsql-errors-and-messages.html">documentation</a>.</p>
<p>Basic logging can be done using the <code>RAISE</code> command:</p>
<pre><code class="language-SQL">RAISE NOTICE 'Some message';
</code></pre>
<p>We can add parameters by using the <code>%</code> placeholder:</p>
<pre><code class="language-SQL">RAISE NOTICE 'Some message %', &lt;expression&gt;;
</code></pre>
<p>Only scalar expressions are allowed as parameters. If we need to log multiple rows, we have to use a loop:</p>
<pre><code class="language-SQL">FOR row IN SELECT ... LOOP
    RAISE NOTICE 'Some message %, %', row.column_1, row.column_2;
END LOOP;
</code></pre>
<h2 id="executing-functions">Executing functions<a class="headerlink" href="#executing-functions" title="Permanent link">&para;</a></h2>
<p>In SQL, any function is executed using the <code>SELECT</code> statement:</p>
<pre><code class="language-SQL">SELECT * FROM &lt;function name&gt;(&lt;function arguments&gt;); -- for functions with return value

SELECT &lt;function name&gt;(&lt;function arguments&gt;); -- for functions returning void or if we do not care about the return value
</code></pre>
<p>In PL/pgSQL, the second syntax where the return value is not used is not allowed. Instead, we have to use the <code>PERFORM</code> statement:</p>
<pre><code class="language-SQL">PERFORM &lt;function name&gt;(&lt;function arguments&gt;);
</code></pre>
<h2 id="exceptions">Exceptions<a class="headerlink" href="#exceptions" title="Permanent link">&para;</a></h2>
<p>In PL/pgSQL, we can have both exceptions raised by the database and exceptions that are manually raised in user code.</p>
<h3 id="handling-exceptions">Handling exceptions<a class="headerlink" href="#handling-exceptions" title="Permanent link">&para;</a></h3>
<p><a href="https://www.postgresql.org/docs/current/plpgsql-control-structures.html#PLPGSQL-ERROR-TRAPPING">Documentation</a></p>
<p>In PL/pgSQL, we can handle exceptions by extending the block with the <code>EXCEPTION</code> part. The syntax is as follows:</p>
<pre><code class="language-SQL">BEGIN
    ...
EXCEPTION
    WHEN &lt;exception condition&gt; THEN
        &lt;exception handling&gt;
END
</code></pre>
<p>The list of built-in exception codes can be found in the <a href="https://www.postgresql.org/docs/current/errcodes-appendix.html">documentation</a>. The most common exceptions are:</p>
<ul>
<li><code>P0001</code>, <code>raise_exception</code>: A user-raised exception that does not specify the SQLSTATE.</li>
<li><code>00000</code>, <code>successful_completion</code>: The normal completion of a statement. No exception should ever be raised with this SQLSTATE.</li>
</ul>
<p>Apart from the built-in codes, we can introduce our own. They have to be five characters long and start with a letter.</p>
<p>The <code>&lt;exception handling&gt;</code> part can be any valid PL/pgSQL code. It can contain multiple statements and can be nested.</p>
<p>The <code>&lt;exception condition&gt;</code> can have three forms:</p>
<ul>
<li><code>WHEN &lt;exception name&gt;</code>: catches the exception with the specified name</li>
<li><code>WHEN SQLSTATE '&lt;SQLSTATE&gt;'</code>: catches the exception with the specified SQLSTATE</li>
<li><code>WHEN OTHERS</code>: catches all exceptions that are not caught by the previous <code>WHEN</code> clauses</li>
</ul>
<p>There can be many <code>WHEN</code> clauses in a single <code>EXCEPTION</code> block. If there is no matching <code>WHEN</code> clause for the exception, the exception is propagated as if there was no <code>EXCEPTION</code> block at all.</p>
<p>Note that the <strong>code <code>00000</code> cannot be caught by the <code>WHEN '00000'</code> clause. Such condition is interpreted as <code>WHEN OTHERS</code></strong>.</p>
<p>When handling an exception, we can use two special built-in variables:</p>
<ul>
<li><code>SQLSTATE</code>: the SQLSTATE of the exception - a five-character code that specifies the exception type</li>
<li><code>SQLERRM</code>: the error message of the exception</li>
</ul>
<h3 id="raising-exceptions">Raising exceptions<a class="headerlink" href="#raising-exceptions" title="Permanent link">&para;</a></h3>
<p><a href="https://www.postgresql.org/docs/current/plpgsql-errors-and-messages.html">Documentation</a></p>
<p>To raise an exception, we use the <code>RAISE</code> statement, the same as for logging. The difference is in the level parameter, which we must set to <code>EXCEPTION</code> (default):</p>
<pre><code class="language-SQL">RAISE EXCEPTION 'Some message'; -- exception
RAISE 'Some message'; -- exception
RAISE &lt;another level&gt; 'Some message'; -- just a message
</code></pre>
<h2 id="query-diagnostics">Query diagnostics<a class="headerlink" href="#query-diagnostics" title="Permanent link">&para;</a></h2>
<p>Various information about the last query can be obtained using the <code>GET DIAGNOSTIC</code> command. For example, the number of rows affected by the last query can be obtained using the <code>ROW_COUNT</code> parameter:</p>
<pre><code class="language-SQL">GET DIAGNOSTIC &lt;variable&gt; = ROW_COUNT;
</code></pre>
<p>The result is stored in the variable <code>&lt;variable&gt;</code>.</p>
<p>Note that this constract is not available in the SQL queries but only in a PL/pgSQL block.</p>
<p>For other diagnostic fields, see the <a href="https://www.postgresql.org/docs/current/plpgsql-statements.html#PLPGSQL-STATEMENTS-DIAGNOSTICS">documentation</a>.</p>
<h2 id="transaction-management">Transaction management<a class="headerlink" href="#transaction-management" title="Permanent link">&para;</a></h2>
<p>By default, PostgreSQL starts a transaction at the beginning of the outermost <em>block</em>, and end it at the end of the block.</p>
<p>We can manually commit or rollback the transaction, but only inside a procedure that is on a procedure-only call stack:</p>
<ul>
<li><code>procedure 1 -&gt; procedure 2 -&gt; procedure 3</code>: all three procedures can commit or rollback the transaction</li>
<li><code>procedure 1 -&gt; function 2 -&gt; procedure 3</code>: only procedure 1 can commit or rollback the transaction</li>
<li><code>function 1 -&gt; procedure 2 -&gt; function 3</code>: neither procedure nor function can commit or rollback the transaction.</li>
</ul>
<h3 id="subtransactions">Subtransactions<a class="headerlink" href="#subtransactions" title="Permanent link">&para;</a></h3>
<p>So far, we covered the top-level transactions. However, there are also subtransactions. Subtransactions cannot be handled manually, however, we can manipulate them, if we know the logic of the automatic subtransaction management.</p>
<p>The subtransactions are started:</p>
<ul>
<li>inside each block with the exception management<ul>
<li>these subtransactions are rolled back if an exception is raised</li>
</ul>
</li>
</ul>
<h1 id="psql"><code>psql</code><a class="headerlink" href="#psql" title="Permanent link">&para;</a></h1>
<p><a href="https://www.postgresql.org/docs/current/app-psql.html">Documentation</a></p>
<p><code>psql</code> is a basic command line utitilty for manipulating postgres database. </p>
<p>To connect, type:</p>
<pre><code class="language-bash">psql -d &lt;db name&gt; 
</code></pre>
<p>Then the SQL commands can be executed. </p>
<p>Note that no matter what SQL commands you plan to execute, <strong>you have to connect to a specific database</strong>. Ommitting the <code>-d</code> parameter will not connect you to the server in some admin mode, but instead, it will connect you to the default database, which is usually the database with the same name as the user name. If there is no such database, the connection will fail.</p>
<p>To execute command immediatelly without starting interactive session, use the <code>-c</code> parameter:</p>
<pre><code class="language-bash">psql -d &lt;db name&gt; -c &quot;&lt;command&gt;&quot;
</code></pre>
<p>Do not forget to quote the command. Also, note that certain SQL commands, such as <code>CREATE DATABASE</code> requires its own session. To combine them with other SQL commands, you can use multiple <code>-c</code> parameters:</p>
<pre><code class="language-bash">psql -d &lt;db name&gt; -c &quot;CREATE DATABASE &lt;db name&gt;&quot; -c &quot;&lt;other command&gt;&quot;
</code></pre>
<p>Other useful parameters:</p>
<ul>
<li><code>-X</code>: do not read the <code>~/.psqlrc</code> file. This is useful when debuging the <code>psql</code> commands or running scripts, as it disables any customizations.</li>
<li><code>-U &lt;user name&gt;</code>: connect as a different user. If not specified, the current user is used.</li>
<li><code>-p</code><port number>: specify the port number.  (default is 5432)</li>
</ul>
<h2 id="meta-commands">meta-commands<a class="headerlink" href="#meta-commands" title="Permanent link">&para;</a></h2>
<p>The <code>psql</code> has its own set of commands, called <em>meta-commands</em>. These commands start with a backslash (<code>\</code>) and can be used inside SQL queries (either interactively, or in the -c argument). Example:</p>
<pre><code class="language-bash">psql -d &lt;db name&gt; -c &quot;\l+&quot;
</code></pre>
<p>The above command lists all databases, including additional information.</p>
<p>Note that the <strong>meta-commands cannot be combined with SQL queries passed to the <code>-c</code> parameter</strong>. As <code>-c</code> argument, we can use either:</p>
<ul>
<li>a plain SQL query without any meta-commands</li>
<li>a single meta-command without any SQL query (like the example above)</li>
</ul>
<p><em>(In</em> <code>\copy public.nodes FROM nodes.csv CSV HEADER</code><em>, the string after <code>\copy</code> is a list of arguments, not an SQL query)</em></p>
<p>When we want to combine a meta-command with an SQL query, we need to use some of the workarounds:</p>
<ul>
<li>use the <code>psql</code> interactive mode</li>
<li>use the <code>psql</code> <code>--file</code> parameter to execute a script from a file</li>
<li>pipe the commands to <code>psql</code> using <code>echo</code>:
    <code>bash
    echo "COPY (SELECT * FROM opendata.public.nodes WHERE area = 13) TO STDOUT WITH CSV HEADER \g 'nodes.csv'" | psql -d opendata</code></li>
</ul>
<h1 id="importing-data">Importing data<a class="headerlink" href="#importing-data" title="Permanent link">&para;</a></h1>
<p>A simple SQL data (database dump) can be imported using the <code>psql</code> command:</p>
<pre><code class="language-bash">psql -d &lt;db name&gt; -f &lt;file name&gt;
</code></pre>
<p>we can also import from stdin by omitting the <code>-f</code> parameter:</p>
<pre><code class="language-bash">psql -d &lt;db name&gt; &lt; &lt;file name&gt;

# or
&lt;command&gt; | psql -d &lt;db name&gt;
</code></pre>
<h2 id="importing-compressed-sql-dump">Importing compressed SQL dump<a class="headerlink" href="#importing-compressed-sql-dump" title="Permanent link">&para;</a></h2>
<p>To import a compressed SQL dump we need to know how the dump was compressed. </p>
<ul>
<li>
<p>If it was compressed using the <code>pg_dump</code> with the <code>-Z</code> parameter, we use a <code>pg_restore</code> command:
    <code>bash
    pg_restore -d &lt;db name&gt; &lt;file name&gt;</code></p>
</li>
<li>
<p>If it was compressed using a compression tool, we need to pipe the output to the decompression tool and then to <code>psql</code>:
    <code>bash
    &lt;decompression tool&gt; &lt; &lt;file name&gt; | psql -d &lt;db name&gt;</code></p>
</li>
</ul>
<h2 id="importing-data-from-csv">Importing data from csv<a class="headerlink" href="#importing-data-from-csv" title="Permanent link">&para;</a></h2>
<p>The easiest way to import data from csv is to use the <code>psql</code> <code>\copy</code> meta-command:</p>
<pre><code class="language-bash">psql -d &lt;db name&gt; -c &quot;\copy &lt;table name&gt; FROM &lt;file name&gt; CSV HEADER&quot;
</code></pre>
<p>The syntax of this command and its parameters is almost identical to the <a href="https://www.postgresql.org/docs/current/sql-copy.html"><code>COPY</code></a> command. Important parameters:</p>
<ul>
<li><code>CSV</code>: the file is in CSV format</li>
<li><code>HEADER</code>: the first line of the file contains column names</li>
</ul>
<p>Except simplicity, the <code>\copy</code> command has another advantage over the <code>COPY</code> command: it has the same access rights as the user that is currently logged in. The <code>COPY</code> command, on the other hand, has the access rights of the user that started the database server. </p>
<p>The <code>COPY</code> command, however, has an advantage over the <code>\copy</code> command when we access a remote database. In that case, the <code>\copy</code> command would first download the whole file to the client and then upload it to the server. The <code>COPY</code> command, on the other hand, can be executed directly on the server, so the data are not downloaded to the client.</p>
<h3 id="importing-data-from-csv-with-columns-than-are-not-in-the-db-table">Importing data from csv with columns than are not in the db table<a class="headerlink" href="#importing-data-from-csv-with-columns-than-are-not-in-the-db-table" title="Permanent link">&para;</a></h3>
<p>The <code>COPY</code> (and <code>\copy</code>) command can be used to copy the input into a database table even if it contains only a subset of database table columns. However, it does not work the other way, i.e, all input columns have to be used. If only a subset of input columns needs to be used, or some of the input columns requires processing, we need to use some workaround. The prefered mathod depends on the characte of the data: </p>
<ul>
<li>data do not match the table, but they are small: <ol>
<li>load the data with pandas</li>
<li>process the data as needed</li>
<li>use <code>pandas.to_sql</code> to upload the data</li>
</ol>
</li>
<li>data do not match the table and they are large:<ol>
<li>preprocess the data with batch commands</li>
<li>use <code>COPY</code> (or <code>\copy</code>) to upload the data</li>
</ol>
</li>
<li>data do not match the table and they are large <em>and dirty</em>: use the <a href="https://www.postgresql.org/docs/current/file-fdw.html"><code>file_fdw</code></a> module:       <ol>
<li>create a table for SQL mapping with tolerant column types (e.g., text for problematic columns)</li>
<li>select from the mapping to the real table</li>
</ol>
</li>
</ul>
<h2 id="importing-data-from-a-shapefile">Importing data from a shapefile<a class="headerlink" href="#importing-data-from-a-shapefile" title="Permanent link">&para;</a></h2>
<p>There are multiple options:</p>
<ul>
<li><code>shp2psql</code>: simple tool that creates sql from a shapefile<ul>
<li>easy start, almost no configuration</li>
<li>always imports all data from shapefile, cannot be configured to skip columns</li>
<li>included in the Postgres instalation</li>
</ul>
</li>
<li><code>ogr2ogr</code><ul>
<li>needs to be installed, part of GDAL</li>
</ul>
</li>
<li><code>QGIS</code><ul>
<li>The db manger can be used to export data from <code>QGIS</code></li>
<li>data can be viewed before import</li>
<li>only suitable for creating new table, not for appending to an existing one</li>
</ul>
</li>
</ul>
<h2 id="importing-data-from-geojson">Importing data from GeoJSON<a class="headerlink" href="#importing-data-from-geojson" title="Permanent link">&para;</a></h2>
<p>For a single geometry stored in a GeoJSON file, the function <a href="http://postgis.net/docs/ST_GeomFromGeoJSON.html"><code>ST_GeomFromGeoJSON</code></a> can be used.</p>
<ul>
<li>just copy the geometry part of the file</li>
<li>change the geometry type to match the type in db</li>
<li>don't forget to surround the object with curly brackets</li>
</ul>
<p>For the whole document, the <code>ogr2ogr</code> tool can be used.</p>
<h1 id="exporting-data">Exporting data<a class="headerlink" href="#exporting-data" title="Permanent link">&para;</a></h1>
<p>The data can be exported to SQL using the <code>pg_dump</code> command. The simplest usage is:</p>
<pre><code class="language-bash">pg_dump -f &lt;output file name&gt; &lt;db name&gt;
</code></pre>
<p>Important parameters:</p>
<ul>
<li><code>-s</code>: export only the schema, not the data</li>
</ul>
<p>If we need to further process the data, we can use the stdout as an output simply by omitting the <code>-f</code> parameter:</p>
<pre><code class="language-bash">pg_dump &lt;db name&gt; | &lt;command&gt;
</code></pre>
<h2 id="exporting-the-database-server-configuration">Exporting the database server configuration<a class="headerlink" href="#exporting-the-database-server-configuration" title="Permanent link">&para;</a></h2>
<p>To export the database server configuration, we can use the <code>pg_dumpall</code> command:</p>
<pre><code class="language-bash">pg_dumpall -f &lt;output file name&gt;
</code></pre>
<h2 id="compressing-the-sql-dump">Compressing the SQL dump<a class="headerlink" href="#compressing-the-sql-dump" title="Permanent link">&para;</a></h2>
<p>To compress the SQL dump, we have two options:</p>
<ul>
<li>use the <code>pg_dump</code> command with the <code>-Z</code> parameter, e.g., <code>pg_dump &lt;db name&gt; -Z1 -f &lt;output file name&gt;</code> or</li>
<li>pipe the output to a compression tool, e.g., <code>pg_dump &lt;db name&gt; | gzip &gt; &lt;output file name&gt;</code></li>
</ul>
<h2 id="exporting-data-to-csv">Exporting data to csv<a class="headerlink" href="#exporting-data-to-csv" title="Permanent link">&para;</a></h2>
<p>When exporting large data sets, it is not wise to export them as an SQL dump. To export data to csv, we can use either:</p>
<ul>
<li><code>psql</code> <code>\copy</code> command</li>
<li><code>COPY</code> command in SQL</li>
</ul>
<p>The simplest way is to use the <code>\copy</code> command. However, it may be slow if we call psql from a client and we want to export the data to a file on the server, because the data are first sent to the client and then back to the server. </p>
<p>The <code>COPY</code> command is the fastest way to export data to the server. However, by default, it can be tricky to use, as the sql server needs to have write access to the file. To overcome this problem, we can use the following workaround:</p>
<ol>
<li>choose <code>STDOUT</code> as an output for the <code>COPY</code> command</li>
<li>at the end of the command, add <code>\g &lt;file name&gt;</code> to redirect the output to a file.</li>
</ol>
<p>Example:</p>
<pre><code class="language-bash">echo &quot;COPY (SELECT * FROM opendata.public.nodes WHERE area = 13) TO STDOUT WITH CSV HEADER \g 'nodes.csv'&quot; | psql -d opendata
</code></pre>
<h1 id="information-and-statistics">Information and statistics<a class="headerlink" href="#information-and-statistics" title="Permanent link">&para;</a></h1>
<p>To show the <strong>table size</strong>, run:</p>
<pre><code class="language-PostgreSQL">SELECT pg_size_pretty(pg_total_relation_size('&lt;table name&gt;'));
</code></pre>
<p>To show the <strong>version</strong> of the PostgreSQL server, run:</p>
<pre><code class="language-PostgreSQL">SELECT version();
</code></pre>
<p>To list all <strong>extensions</strong> for a database, run:</p>
<pre><code class="language-PostgreSQL">psql -d &lt;db name&gt; -c &quot;\dx&quot;
</code></pre>
<p>To check if a <strong>specific table</strong> exists, run:</p>
<pre><code class="language-PostgreSQL">SELECT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = '&lt;schema_name&gt;' AND table_name = '&lt;table_name&gt;');
</code></pre>
<h2 id="databases">Databases<a class="headerlink" href="#databases" title="Permanent link">&para;</a></h2>
<p>To list all databases, we can use the <code>-l</code> parameter:</p>
<pre><code class="language-bash">psql -l
</code></pre>
<p>To get more information about the databases, we can use the <code>\l+</code> meta-command.</p>
<p>To check if a specific database exists, we can use the following query:</p>
<pre><code class="language-SQL">SELECT EXISTS (SELECT 1 FROM pg_database WHERE datname = '&lt;db name&gt;');
</code></pre>
<h1 id="pgrouting">PgRouting<a class="headerlink" href="#pgrouting" title="Permanent link">&para;</a></h1>
<p><a href="https://docs.pgrouting.org/latest/en/index.html">documentation</a></p>
<p><a href="https://pgrouting.org/">PgRouting</a> is a PostgreSQL extension focused on graph/network manpulation. It contains functions for:</p>
<ul>
<li>finding the strongly connected components: <a href="https://docs.pgrouting.org/latest/en/pgr_strongComponents.html#index-0"><code>pgr_strongComponents</code></a></li>
<li><a href="https://docs.pgrouting.org/latest/en/contraction-family.html">graph contraction/simplification</a>: <a href="https://docs.pgrouting.org/latest/en/pgr_contraction.html"><code>pgr_contraction</code></a></li>
<li>creating vertices from edges: <a href="https://docs.pgrouting.org/latest/en/pgr_createVerticesTable.html"><code>pgr_createVerticesTable</code></a></li>
</ul>
<h2 id="finding-strongly-connected-components">Finding strongly connected components<a class="headerlink" href="#finding-strongly-connected-components" title="Permanent link">&para;</a></h2>
<p>The function <a href="https://docs.pgrouting.org/latest/en/pgr_strongComponents.html#index-0"><code>pgr_strongComponents</code></a> finds the strongly connected components of a graph. The only parameter of the script is a query that should return edge data in the folowing format:</p>
<ul>
<li><code>id</code>, </li>
<li><code>source</code>,</li>
<li><code>target</code>, </li>
<li><code>cost</code>,</li>
<li><code>reverse_cost</code>.</li>
</ul>
<p>The first three parameters are obvious. The cost parameter does not have any effect. <strong>You should provide a negative <code>reverse_cost</code>, othervise, the edge will be considered as bidirectional!</strong></p>
<h2 id="creating-vertices-from-edges">Creating vertices from edges<a class="headerlink" href="#creating-vertices-from-edges" title="Permanent link">&para;</a></h2>
<p>The function <a href="https://docs.pgrouting.org/latest/en/pgr_createVerticesTable.html"><code>pgr_createVerticesTable</code></a> creates a table of vertices from a table of edges. The function has the following parameters:</p>
<ul>
<li><code>edges_table</code>: the name of the table with edges. It must be a standard table, temporary tables are not supported.</li>
<li><code>the_geom</code>: the name of the geometry column in the <code>edges_table</code></li>
<li><code>source</code>: the name of the source column in the <code>edges_table</code></li>
<li><code>target</code>: the name of the target column in the <code>edges_table</code></li>
</ul>
<p>The return value is <code>OK</code> if the function was successful and <code>FAIL</code> if it was not.</p>
<p>The created vertices table is named <code>&lt;edges_table&gt;_vertices_pgr</code> and contains the following columns:</p>
<ul>
<li><code>id</code>: the id of the vertex</li>
<li><code>the_geom</code>: the geometry of the vertex</li>
<li><code>cnt</code>: the number of edges that are connected to the vertex</li>
<li><code>chk</code>: an integer that indicates if the vertex might have a problem. </li>
<li><code>ein</code>: the number of incoming edges</li>
<li><code>eout</code>: the number of outgoing edges</li>
</ul>
<p>Note that <strong>only the <code>id</code>, and <code>the_geom</code> columns are filled with data. The other columns are filled with <code>NULL</code>.</strong> </p>
<p>To fill the <code>cnt</code> and <code>chk</code> columns, we can use the <a href="https://docs.pgrouting.org/latest/en/pgr_analyzeGraph.html"><code>pgr_analyzeGraph</code></a> function. </p>
<p>To fill all columns, we need to use the <a href="https://docs.pgrouting.org/latest/en/pgr_analyzeOneway.html"><code>pgr_analyzeOneway</code></a> function. However, this function is cumbersome to use, as it requires a lot of parameters.</p>
<h1 id="testing-with-pgtap">Testing with PgTAP<a class="headerlink" href="#testing-with-pgtap" title="Permanent link">&para;</a></h1>
<p><a href="https://pgtap.org/documentation.html">Official documentation</a></p>
<p><a href="https://pgtap.org/">PgTAP</a> is the only testing framework for PostgreSQL. It is a system framwork: it requires administrative privileges to install.</p>
<h2 id="installation">Installation<a class="headerlink" href="#installation" title="Permanent link">&para;</a></h2>
<h3 id="linux">Linux<a class="headerlink" href="#linux" title="Permanent link">&para;</a></h3>
<p>If you are using Linux, you may (depending on your distribution) be able to use you distribution's package management system to install pgTAP. For instance, on Debian, Ubuntu, or Linux Mint pgTAP can be installed with the command: <code>sudo apt-get install pgtap</code></p>
<p>On other systems pgTAP has to be downloaded and built. First, download pgTAP from <a href="https://pgxn.org/dist/pgtap/">PGXN</a> (click the green download button in the upper-right). Extract the downloaded zip file, and (at the command line) navigate to the extracted folder.</p>
<p>To build pgTAP and install it into a PostgreSQL database, run the following commands:</p>
<pre><code class="language-sh">make
make install
make installcheck
</code></pre>
<h3 id="windows">Windows<a class="headerlink" href="#windows" title="Permanent link">&para;</a></h3>
<p>To install pgtap for PostgreSQL on Windows, follow these steps:</p>
<ol>
<li>Clone the <a href="https://github.com/theory/pgtap">pgtap repository</a></li>
<li>Open PowerShell (<code>pwsh</code>) as an Administrator<ul>
<li>it is necessary to copy files into the <code>ProgramFiles</code> directory.</li>
</ul>
</li>
<li>run the <a href="https://gist.github.com/F-I-D-O/7752c29590f2867ce502590453ed04e7"><code>pgtap_install.ps1</code></a> script as an administrator with the following command:
    <code>PowerShell
    pgtap_install.ps1 &lt;path to pgtap clone&gt;</code><ul>
<li>This script will copy the necessary files to the PostgreSQL installation directory.</li>
</ul>
</li>
</ol>
<p>These instructions were adapted from <a href="https://github.com/theory/pgtap/issues/192#issuecomment-960033060">issue#192</a> of the pgtap repository.</p>
<h2 id="basic-usage-test-scripts">Basic Usage - Test scripts<a class="headerlink" href="#basic-usage-test-scripts" title="Permanent link">&para;</a></h2>
<p>The easiest way to write tests in PgTAP is to write procedural SQL scripts that contain the tests. The basic test can look like this:</p>
<pre><code class="language-SQL">BEGIN; -- Start a transaction

-- Specify that we plan to run 2 tests
SELECT plan(2);

-- Test 1: Check if basic arithmetic works as expected
SELECT is(1 + 1, 2, '1 + 1 equals 2');

-- Test 2: Verify string concatenation
SELECT is('Hello ' || 'World', 'Hello World', 'String concatenation works');
--

-- Run the tests and return results
SELECT * FROM finish();

ROLLBACK; -- Rollback the transaction
</code></pre>
<p>here, we create two assertions using the <code>is</code> function from the <code>pgtap</code> library. Then, we run the tests using the <code>finish</code> function. The whole test is wrapped in a transaction, so the database is not modified by the test.</p>
<p>To execute the test, we can:</p>
<ul>
<li>run the test SQL directly in the SQL console or with the <code>psql</code> command</li>
<li>use the <code>pg_prove</code> command to run the test from the command line</li>
</ul>
<h2 id="pg_prove"><code>pg_prove</code><a class="headerlink" href="#pg_prove" title="Permanent link">&para;</a></h2>
<p>The <code>pg_prove</code> is a Perl test runner that can be used to run the pgtap tests. We need to install it first using <code>cpanm TAP::Parser::SourceHandler::pgTAP</code>.</p>
<p>Then, we can use it as:</p>
<pre><code class="language-bash">pg_prove -d &lt;db name&gt; -U &lt;user name&gt; &lt;test file&gt;
</code></pre>
<h2 id="test-as-functions">Test as functions<a class="headerlink" href="#test-as-functions" title="Permanent link">&para;</a></h2>
<p>Instead of writing the tests in a procedural SQL script, we can write them as functions (<strong>but not procedures!</strong>). This can help as organizing tests and also to prepare the data for the tests.</p>
<p>Test functions must return the <code>SETOF TEXT</code> type. This correspond to the type returned by the provided <a href="#test-assertions">test assertions</a>.</p>
<h3 id="test-runner">Test runner<a class="headerlink" href="#test-runner" title="Permanent link">&para;</a></h3>
<p>There is also a runner function <a href="https://pgtap.org/documentation.html#runtests"><code>runtests</code></a> that can be used to run multiple tests at once:</p>
<pre><code class="language-SQL">SELECT * FROM runtests();
</code></pre>
<p>This function has four variants:</p>
<ul>
<li><code>runtests()</code>,</li>
<li><code>runtests(&lt;schema&gt;)</code>,</li>
<li><code>runtests(&lt;pattern&gt;)</code>, and</li>
<li><code>runtests(&lt;schema&gt;, &lt;pattern&gt;)</code>.</li>
</ul>
<p>The <code>schema</code> parameter is used to specify the schema where the tests are searched. The <code>pattern</code> parameter is used to specify the pattern that the test names must match. The pattern uses the same syntax as the <code>LIKE</code> operator in SQL.</p>
<h3 id="fixtures">Fixtures<a class="headerlink" href="#fixtures" title="Permanent link">&para;</a></h3>
<p>Sometimes, we need to call some functions before and after the tests. We can indeed call these functions in from the test functions, but in case we need to run the same functions for multiple tests, it is desirable to automate this process using fixtures. The <code>runtests</code> function supports fixtures, it recognize them by the prefix. Again, only functions, not procedures are supported. The following fixtures are supported:</p>
<ul>
<li><code>startup</code>: runs before the tests</li>
<li><code>setup</code>: runs before each test</li>
<li><code>teardown</code>: runs after each test</li>
<li><code>shutdown</code>: runs after the tests</li>
</ul>
<p>Unfortunatelly, the <strong>fixture search does not reflect the filtration <code>&lt;pattern&gt;</code></strong>. Therefore, all fixtures in the schema are always run. To overcome this, we have to supply a custom function for executing the tests.</p>
<p>Also note that all the fixtures are executed for all the tests, not just the ones with the matching name. Therefore they cannot be used for preparing the data for individual tests.</p>
<h3 id="rolling-back">Rolling back<a class="headerlink" href="#rolling-back" title="Permanent link">&para;</a></h3>
<p>All tests are executed in a transaction and each test is then in a subtransaction. All database changes are rolled back except the ones that are in the <code>startup</code> and <code>shutdown</code> fixtures <a href="https://groups.google.com/g/pgtap-users/c/enU925h6cxU/m/fb0-S3kqBwAJ?pli=1">[source]</a>. Additionally, some changes, e.g. the sequence numbers cannot be rolled back.</p>
<h2 id="test-assertions">Test assertions<a class="headerlink" href="#test-assertions" title="Permanent link">&para;</a></h2>
<p>PgTAP provides a set of functions that works as test assertions. All functions have an optional <code>&lt;message&gt;</code> parameter. Notable functions are:</p>
<ul>
<li><code>ok(&lt;condition&gt;, &lt;message&gt;)</code>: checks if the <code>&lt;condition&gt;</code> is true</li>
<li><code>is(&lt;computed&gt;, &lt;expected&gt;, &lt;message&gt;)</code> or <code>isnt(&lt;computed&gt;, &lt;not expected&gt;, &lt;message&gt;)</code>: checks if <code>&lt;computed&gt;</code> and <code>&lt;expected&gt;</code> are the same, or not (respectively).</li>
<li><code>matches(&lt;text&gt;, &lt;pattern&gt;, &lt;message&gt;)</code> or <code>doesnt_match(&lt;text&gt;, &lt;pattern&gt;, &lt;message&gt;)</code>: checks if <code>&lt;text&gt;</code> matches the <code>&lt;pattern&gt;</code> where <code>&lt;pattern&gt;</code> is a regular expression, or not (respectively).</li>
<li><code>alike(&lt;text&gt;, &lt;pattern&gt;, &lt;message&gt;)</code> or <code>unalike(&lt;text&gt;, &lt;pattern&gt;, &lt;message&gt;)</code>: checks if <code>&lt;text&gt;</code> is similar to <code>&lt;pattern&gt;</code>, or not (respectively). The <code>LIKE</code> operator is used for the comparison.</li>
<li><code>cmp_ok(&lt;computed&gt;, &lt;operator&gt;, &lt;expected&gt;, &lt;message&gt;)</code>: checks if <code>&lt;computed&gt;</code> is related to <code>&lt;expected&gt;</code> by the <code>&lt;operator&gt;</code>. The <code>&lt;operator&gt;</code> can be one of the following: <code>=</code>, <code>!=</code>, <code>&gt;</code>, <code>&gt;=</code>, <code>&lt;</code>, <code>&lt;=</code>.</li>
<li><code>isa_ok(&lt;value&gt;, &lt;type&gt;, &lt;message&gt;)</code>: checks if <code>&lt;value&gt;</code> is of type <code>&lt;type&gt;</code>.</li>
<li><code>throws_ok(&lt;sql&gt;, &lt;error_code&gt;, &lt;error_message&gt;, &lt;message&gt;)</code>: checks if the <code>&lt;sql&gt;</code> throws an exception.<ul>
<li>all parameters except the <code>&lt;sql&gt;</code> are optional</li>
</ul>
</li>
<li><code>lives_ok(&lt;sql&gt;, &lt;message&gt;)</code>: checks if the <code>&lt;sql&gt;</code> does not throw an exception.</li>
</ul>
<p>Additionaly, if the test condition is complicated, we can just manually return using the <code>pass(&lt;message&gt;)</code> or <code>fail(&lt;message&gt;)</code> functions.</p>
<h3 id="result-set-assertions">Result set assertions<a class="headerlink" href="#result-set-assertions" title="Permanent link">&para;</a></h3>
<ul>
<li><code>results_eq(&lt;sql&gt;, &lt;sql&gt;, &lt;description&gt;)</code>: Compares two SQL query results row-by-row for equality, ensuring integrity and order.</li>
<li><code>results_eq(&lt;sql&gt;, &lt;array&gt;, &lt;description&gt;)</code>: Compares SQL query results to an array.</li>
<li><code>results_eq(&lt;cursor&gt;, &lt;cursor&gt;, &lt;description&gt;)</code>: Compares results from two cursors.</li>
<li><code>results_eq(&lt;sql&gt;, &lt;cursor&gt;, &lt;description&gt;)</code>: Compares SQL query results to cursor results.</li>
<li><code>results_eq(&lt;cursor&gt;, &lt;array&gt;, &lt;description&gt;)</code>: Compares cursor results to an array.</li>
<li><code>results_ne(&lt;...&gt;, &lt;description&gt;)</code>: The inverse of <code>results_eq()</code>. Checks if result sets are not equal (accepts the same argument variations as <code>results_eq</code>).</li>
<li><code>set_eq(&lt;...&gt;, &lt;description&gt;)</code>: Compares result sets for equality, ignoring order (accepts the same argument variations as <code>results_eq</code>).</li>
<li><code>set_ne(&lt;...&gt;, &lt;description&gt;)</code>: The inverse of <code>set_eq()</code>. Checks if result sets are not equal, ignoring order (accepts the same argument variations as <code>results_eq</code>).</li>
<li><code>set_has(&lt;sql&gt;, &lt;sql&gt;, &lt;description&gt;)</code>: Checks if the first query's results contain all rows returned by the second query, ignoring order.</li>
<li><code>set_hasnt(&lt;sql&gt;, &lt;sql&gt;, &lt;description&gt;)</code>: The inverse of <code>set_has</code>. Checks if the first query's results do not contain all rows from the second query.</li>
<li><code>bag_eq(&lt;sql&gt;, &lt;sql&gt;, &lt;description&gt;)</code>: Compares result sets like <code>set_eq</code> but considers duplicate rows. If a row appears N times in the first query, it must appear N times in the second.</li>
<li><code>bag_ne(&lt;sql&gt;, &lt;sql&gt;, &lt;description&gt;)</code>: The inverse of <code>bag_eq()</code>.</li>
<li><code>is_empty(&lt;sql&gt;, &lt;description&gt;)</code>: Checks that the SQL query returns no rows.</li>
<li><code>isnt_empty(&lt;sql&gt;, &lt;description&gt;)</code>: Checks that the SQL query returns at least one row.</li>
<li><code>row_eq(&lt;sql&gt;, &lt;record&gt;, &lt;description&gt;)</code>: Checks that the SQL query returns a single row identical to the provided <code>&lt;record&gt;</code>.</li>
</ul>
<h2 id="additional-functions-diagnostics">Additional functions( Diagnostics )<a class="headerlink" href="#additional-functions-diagnostics" title="Permanent link">&para;</a></h2>
<p>The function <a href="https://pgtap.org/documentation.html#diag"><code>diag(&lt;string&gt;, &lt;string&gt;, ...)</code></a>, can be used for outputting diagnostic messages. For example:</p>
<pre><code class="language-sql">-- Output a diagnostic message if the collation is not en_US.UTF-8.
SELECT diag(
     E'These tests expect LC_COLLATE to be en_US.UTF-8,\n',
     'but yours is set to ', setting, E'.\n',
     'As a result, some tests may fail. YMMV.'
)
  FROM pg_settings
 WHERE name = 'lc_collate'
   AND setting &lt;&gt; 'en_US.UTF-8';
</code></pre>
<p>which outputs</p>
<pre><code class="language-plaintext"># These tests expect LC_COLLATE to be en_US.UTF-8,
# but yours is set to en_US.ISO8859-1.
# As a result, some tests may fail. YMMV.
</code></pre>
<p>This function basically concatenates all the arguments and outputs them as a single line of text. All the arguments have to be strings.</p>
<h1 id="xml">XML<a class="headerlink" href="#xml" title="Permanent link">&para;</a></h1>
<p><a href="https://www.postgresql.org/docs/current/functions-xml.html">documentation</a></p>
<p>PostgreSQL has a built-in support for XML. </p>
<p>Important functions:</p>
<ul>
<li><a href="https://www.postgresql.org/docs/current/functions-xml.html#FUNCTIONS-XML-PROCESSING-XPATH"><code>xpath(&lt;path&gt;, &lt;text&gt;, &lt;namespace bindings&gt;)</code></a>: returns an array of XML nodes that match the given <code>&lt;path&gt;</code> evaluated on the given <code>&lt;text&gt;</code>. </li>
</ul>
<p>Besides functions, there is a powerful <a href="#xmltable"><code>XMLTABLE</code> expression</a> that can be used to extract tabular data from XML documents.</p>
<h2 id="handling-xml-namespaces">Handling XML namespaces<a class="headerlink" href="#handling-xml-namespaces" title="Permanent link">&para;</a></h2>
<p>All XML methods in PostgreSQL require the namespace bindings to be specified, as per the XPath standard. The only exception is when work with XML documents that do not use namespaces.</p>
<p>We specify the namespace bindings as an array of arrays, where each inner array has two elements: the prefix and the namespace URI. Example:</p>
<pre><code class="language-SQL">SELECT xpath(
    '/ns:root/ns:child', 
    '&lt;root xmlns:ns=&quot;http://example.com/ns&quot;&gt;&lt;child&gt;...&lt;/child&gt;&lt;/root&gt;', 
    ARRAY[ARRAY['ns', 'http://example.com/ns']]);
</code></pre>
<p>Note that the namespace prefixes specified in the bindings are completely unrelated to the prefixes used in the XML document. They may be the same, but they do not have to be. </p>
<p>Also don't forget that XPath requires the namespace prefixes even for the default namespace. </p>
<h2 id="xmltable"><code>XMLTABLE</code><a class="headerlink" href="#xmltable" title="Permanent link">&para;</a></h2>
<p><a href="https://www.postgresql.org/docs/current/functions-xml.html#FUNCTIONS-XML-PROCESSING-XMLTABLE">Documentation</a></p>
<p><code>XMLTABLE</code> expression can extract tabular data from XML documents. The syntax is as follows:</p>
<pre><code class="language-SQL">XMLTABLE(
    [XMLNAMESPACES(&lt;namespace bindings&gt;),]
    &lt;xpath expression&gt;, PASSING &lt;xml document expression&gt; 
    COLUMNS
        &lt;column name&gt; &lt;data type&gt; PATH &lt;xpath relative expression&gt;,
        ...
        &lt;column name&gt; &lt;data type&gt; PATH &lt;xpath relative expression&gt;
)
</code></pre>
<p>If the XML document contains namespaces, we have to specify the namespace bindings in the <code>XMLNAMESPACES</code> clause. The <code>&lt;namespace bindings&gt;</code> is a comma-separated list of namespace bindings in the format <code>&lt;namespace URI&gt; AS &lt;prefix&gt;</code>. Example:</p>
<pre><code class="language-SQL"> XMLNAMESPACES(
    'http://graphml.graphdrawing.org/xmlns' AS dns,
    'http://www.yworks.com/xml/yfiles-common/3.0' AS y
)
</code></pre>
<p>The <code>&lt;xpath expression&gt;</code> is an XPath expression that specifies the path to the XML nodes from which we want to extract data. The <code>&lt;xpath relative expression&gt;</code> is then another XPath expression that is relative to the <code>&lt;xpath expression&gt;</code> and specifies the path to the XML nodes or attributes used to fill a specific column.</p>
<p>The <code>&lt;xml document expression&gt;</code> is an expression that evaluates to an XML document. Typically, it is a column in the select statement, or a subquery. Example:</p>
<pre><code class="language-SQL">SELECT some_element FROM xml_documents, XMLTABLE(
    XMLNAMESPACES(...),
    '/dns:graph/dns:node' PASSING xml_document.xml_data
    COLUMNS some_element TEXT PATH ...
) FROM xml_documents WHERE id = 1;
</code></pre>
<p>Note that the <em><code>XMLTABLE</code></em> expression may only be used in the <code>FROM</code> clause. Therefore, if we, for example, need to join the result of the <code>XMLTABLE</code>, instead of using: </p>
<pre><code class="language-SQL">JOIN XMLTABLE(...)
</code></pre>
<p>we have to use:</p>
<pre><code class="language-SQL">JOIN (SELECT &lt;columns&gt; FROM XMLTABLE(...))
</code></pre>
<h1 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link">&para;</a></h1>
<p>If the db tools are unresponsive on certain tasks/queries, check if the table needed for those queries is not locke by some problematic query.</p>
<h2 id="select-postgresql-version">Select PostgreSQL version<a class="headerlink" href="#select-postgresql-version" title="Permanent link">&para;</a></h2>
<pre><code class="language-SQL">SELECT version()
</code></pre>
<h2 id="select-postgis-version">Select PostGIS version<a class="headerlink" href="#select-postgis-version" title="Permanent link">&para;</a></h2>
<pre><code class="language-SQL">SELECT PostGIS_version()
</code></pre>
<h2 id="tried-to-send-an-out-of-range-integer-as-a-2-byte-value"><code>Tried to send an out-of-range integer as a 2-byte value</code><a class="headerlink" href="#tried-to-send-an-out-of-range-integer-as-a-2-byte-value" title="Permanent link">&para;</a></h2>
<p>This error is caused by a too large number of values in the insert statement. The maximum index is a 2-byte number (max value: 32767). The solution is to split the insert statement into smaller bulks.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js" defer></script>
        <script src="../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
